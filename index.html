<!DOCTYPE html>
<html>
  <head>
    <title>Udacity Todos Goals</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.1.2/redux.min.js"></script>
    <script src="https://unpkg.com/react@17.0.2/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.17.6/babel.min.js"></script>
    <script src="https://ui.dev/goals-todos-api/index.js"></script>
    <script src="https://unpkg.com/redux-thunk@2.2.0/dist/redux-thunk.min.js"></script>
    <script src="https://unpkg.com/react-redux@7.2.6/dist/react-redux.min.js"></script>
  </head>
  <body>
    <h1>Redux demo state management</h1>

    <div id="app"></div>

    <script type="text/javascript">
      function generateId() {
        return (
          Math.random().toString(36).substring(2) +
          new Date().getTime().toString(36)
        );
      }

      // Use the better ES6 arrow functions, left the old version to see the comparison
      const checker = (store) => (next) => (action) => {
        // function checker(store) {
        // return function (next) {
        // return function (action) {
        if (
          action.type === ADD_TODO &&
          action.todo.name.toLowerCase().includes("bitcoin")
        ) {
          return alert("Nope. That's a bad idea.");
        }

        if (
          action.type === ADD_GOAL &&
          action.goal.name.toLowerCase().includes("bitcoin")
        ) {
          return alert("Nope. That's a bad idea.");
        }

        return next(action);
        //   };
        // };
      };

      const logger = (store) => (next) => (action) => {
        console.group(action.type);
        console.log("The action:", action);
        const result = next(action);
        console.log("The new state: ", store.getState());
        console.groupEnd();
        return result;
      };

      const store = Redux.createStore(
        Redux.combineReducers({
          todos,
          goals,
          loading,
        }),
        Redux.applyMiddleware(ReduxThunk.default, checker, logger)
      );
    </script>

    <script type="text/babel">
      const List = (props) => {
        return (
          <ul>
            {props.items &&
              props.items.map((item) => (
                <li key={item.id}>
                  <span
                    onClick={() => {
                      props.toggle && props.toggle(item.id);
                    }}
                    style={{
                      textDecoration: item.complete ? "line-through" : "",
                    }}
                  >
                    {item.name}
                  </span>
                  <button onClick={() => props.remove(item)}>X</button>
                </li>
              ))}
          </ul>
        );
      };

      const ToDos = (props) => {
        const todoInputRef = React.useRef();

        const addItem = (e) => {
          e.preventDefault();

          props.dispatch(
            handleAddTodo(todoInputRef.current.value, () => {
              todoInputRef.current.value = "";
            })
          );
        };

        const removeItem = (todo) => {
          props.dispatch(handleDeleteTodo(todo));
        };

        const toggleItem = (id) => {
          props.dispatch(handleToggle(id));
        };

        return (
          <div>
            <h1>Todo List</h1>
            <input type="text" placeholder="Add to do" ref={todoInputRef} />
            <button onClick={addItem}>Add Todo</button>
            <List items={props.todos} remove={removeItem} toggle={toggleItem} />
          </div>
        );
      };

      const Goals = (props) => {
        const goalRef = React.useRef();

        const addGoal = (e) => {
          e.preventDefault();

          props.dispatch(
            handleAddGoal(goalRef.current.value, () => {
              goalRef.current.value = "";
            })
          );
        };

        const removeGoal = (goal) => {
          props.dispatch(
            handleDeleteGoal(goal.id, () => {
              props.dispatch(addGoalAction(goal));
            })
          );
        };

        return (
          <div>
            <h1>Goal list</h1>
            <input type="text" placeholder="Add a goal" ref={goalRef} />
            <button onClick={addGoal}>Add goal</button>
            <List items={props.goals} remove={removeGoal} />
          </div>
        );
      };

      // const ConnectedGoals = () => {
      //   return (
      //     <Context.Consumer>
      //       {(store) => {
      //         const { goals } = store.getState();

      //         return <Goals goals={goals} dispatch={store.dispatch} />;
      //       }}
      //     </Context.Consumer>
      //   );
      // };

      const ConnectedGoals = ReactRedux.connect((state) => ({
        goals: state.goals,
      }))(Goals);

      // const ConnectedTodos = () => {
      //   return (
      //     <Context.Consumer>
      //       {(store) => {
      //         const { todos } = store.getState();

      //         return <ToDos todos={todos} dispatch={store.dispatch} />;
      //       }}
      //     </Context.Consumer>
      //   );
      // };

      const ConnectedTodos = ReactRedux.connect((state) => ({
        todos: state.todos,
      }))(ToDos);

      const App = (props) => {
        React.useEffect(() => {
          props.dispatch(handleInitialData());
        }, []);

        {
          if (props.loading === true) return <h3>Loading</h3>;
        }

        return (
          <div>
            <ConnectedTodos />
            <ConnectedGoals />
          </div>
        );
      };

      const ConnectedApp = ReactRedux.connect((state) => ({
        loading: state.loading,
      }))(App);

      ReactDOM.render(
        <ReactRedux.Provider store={store}>
          <ConnectedApp />
        </ReactRedux.Provider>,
        document.getElementById("app")
      );
    </script>
  </body>
</html>
